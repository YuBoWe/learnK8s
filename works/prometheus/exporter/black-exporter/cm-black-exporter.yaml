apiVersion: v1
kind: ConfigMap
metadata:
  name: blackbox-config
  namespace: prometheus
data:
  blackbox.yml: |
    modules:
      # 1. 标准 HTTP 探测 (用于外部域名、API)
      http_2xx:
        prober: http
        timeout: 5s
        http:
          valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
          valid_status_codes: [200, 201, 204, 301, 302]
          method: GET
          follow_redirects: true
          preferred_ip_protocol: "ip4"
          tls_config:
            insecure_skip_verify: false
      
      # 2. 核心业务探测 (如需开启请取消注释，注意保持缩进)
      # http_business_check:
      #   prober: http
      #   timeout: 10s
      #   http:
      #     method: GET
      #     fail_if_body_not_matches_regexp: 
      #       - ".*(User_Profile|Dashboard).*"
      #     fail_if_body_matches_regexp:
      #       - ".*(Connect Error|System Busy|404 Not Found).*"
      #     tls_config:
      #       insecure_skip_verify: false

      # 3. 证书到期监测
      http_ssl_expiry:
        prober: http
        timeout: 10s
        http:
          method: GET
          fail_if_not_ssl: true 

      # 4. TCP 端口探测
      tcp_connect:
        prober: tcp
        timeout: 5s
        tcp:
          preferred_ip_protocol: "ip4"

      # 5. ICMP 探测
      icmp_check:
        prober: icmp
        timeout: 3s
        icmp:
          preferred_ip_protocol: "ip4"

      # 6. DNS 稳定性探测
      dns_standard_check:
        prober: dns
        timeout: 5s
        dns:
          query_name: "www.google.com"
          query_type: "A"
          valid_rcodes: ["NOERROR"]
          validate_answer_rrs:
            fail_if_not_matches_regexp:
              - ".*IN\\s+A\\s+\\d+\\.\\d+\\.\\d+\\.\\d+"
